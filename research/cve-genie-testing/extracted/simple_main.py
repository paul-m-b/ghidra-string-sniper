import os
import shutil
from repoBuilder import RepoBuilder

def main():
    project_to_build = "/home/paul/compilation-test/libpng"
    
    # Ensure my-project exists (already created main.c and Makefile)
    if not os.path.exists(project_to_build):
        print(f"Error: Directory '{project_to_build}' not found. Please ensure main.c and Makefile are created.")
        return

    # Construct project_dir_tree
    project_dir_tree = ""
    for root, dirs, files in os.walk(project_to_build):
        level = root.replace(project_to_build, '').count(os.sep)
        indent = ' ' * 4 * (level)
        project_dir_tree += f'{indent}{os.path.basename(root)}/' # Added newline
        sub_indent = ' ' * 4 * (level + 1)
        for f in files:
            project_dir_tree += f'{sub_indent}{f}' # Added newline

    # Define build pre-requisites for the agent
    build_pre_reqs = {
        "overview": "A simple C program that prints 'Hello, world!'",
        "files": ["main.c", "Makefile"],
        "services": "None",
        "output": "An executable file named 'main'",
    }

    # Set environment variable for the repo path
    os.environ['REPO_PATH'] = project_to_build

    # Instantiate the agent
    agent = RepoBuilder(
        project_dir_tree=project_dir_tree,
        build_pre_reqs=build_pre_reqs,
        cve_knowledge="No CVE knowledge required, simply build the C program.",
        feedback=None,
        critic_feedback=None,
    )

    print(f"Invoking RepoBuilder for project: {project_to_build}")
    # Run the agent
    result = agent.invoke()

    # Print the result
    print("RepoBuilder Result:")
    print(result)

    '''
    # Clean up the created project directory
    print(f"Cleaning up directory: {project_to_build}")
    shutil.rmtree(project_to_build)
    '''

if __name__ == "__main__":
    main()
